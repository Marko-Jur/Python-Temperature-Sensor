                 -1   $MODLP51
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   ACC            DATA 0xe0
0000              5   B              DATA 0xf0
0000              6   PSW            DATA 0xd0
0000              7   SP             DATA 0x81
0000              8   SPX            DATA 0xef
0000              9   DPL            DATA 0x82
0000             10   DPH            DATA 0x83
0000             11   DPLB           DATA 0xd4
0000             12   DPHB           DATA 0xd5
0000             13   PAGE           DATA 0xf6
0000             14   AX             DATA 0xe1
0000             15   BX             DATA 0xf7
0000             16   DSPR           DATA 0xe2
0000             17   FIRD           DATA 0xe3
0000             18   MACL           DATA 0xe4
0000             19   MACH           DATA 0xe5
0000             20   PCON           DATA 0x87
0000             21   AUXR           DATA 0x8e
0000             22   AUXR1          DATA 0xa2
0000             23   DPCF           DATA 0xa1
0000             24   CKRL           DATA 0x97
0000             25   CKCKON0        DATA 0x8f
0000             26   CKCKON1        DATA 0xaf
0000             27   CKSEL          DATA 0x85
0000             28   CLKREG         DATA 0xae
0000             29   OSCCON         DATA 0x85
0000             30   IE             DATA 0xa8
0000             31   IEN0           DATA 0xa8
0000             32   IEN1           DATA 0xb1
0000             33   IPH0           DATA 0xb7
0000             34   IP             DATA 0xb8
0000             35   IPL0           DATA 0xb8
0000             36   IPH1           DATA 0xb3
0000             37   IPL1           DATA 0xb2
0000             38   P0             DATA 0x80
0000             39   P1             DATA 0x90
0000             40   P2             DATA 0xa0
0000             41   P3             DATA 0xb0
0000             42   P4             DATA 0xc0
0000             43   P0M0           DATA 0xe6
0000             44   P0M1           DATA 0xe7
0000             45   P1M0           DATA 0xd6
0000             46   P1M1           DATA 0xd7
0000             47   P2M0           DATA 0xce
0000             48   P2M1           DATA 0xcf
0000             49   P3M0           DATA 0xc6
0000             50   P3M1           DATA 0xc7
0000             51   P4M0           DATA 0xbe
0000             52   P4M1           DATA 0xbf
0000             53   SCON           DATA 0x98
0000             54   SBUF           DATA 0x99
0000             55   SADEN          DATA 0xb9
0000             56   SADDR          DATA 0xa9
0000             57   BDRCON         DATA 0x9b
0000             58   BRL            DATA 0x9a
0000             59   TCON           DATA 0x88
0000             60   TMOD           DATA 0x89
0000             61   TCONB          DATA 0x91
0000             62   TL0            DATA 0x8a
0000             63   TH0            DATA 0x8c
0000             64   TL1            DATA 0x8b
0000             65   TH1            DATA 0x8d
0000             66   RL0            DATA 0xf2
0000             67   RL1            DATA 0xf3
0000             68   RH0            DATA 0xf4
0000             69   RH1            DATA 0xf5
0000             70   WDTRST         DATA 0xa6
0000             71   WDTPRG         DATA 0xa7
0000             72   T2CON          DATA 0xc8
0000             73   T2MOD          DATA 0xc9
0000             74   RCAP2H         DATA 0xcb
0000             75   RCAP2L         DATA 0xca
0000             76   TH2            DATA 0xcd
0000             77   TL2            DATA 0xcc
0000             78   SPCON          DATA 0xc3
0000             79   SPSTA          DATA 0xc4
0000             80   SPDAT          DATA 0xc5
0000             81   SSCON          DATA 0x93
0000             82   SSCS           DATA 0x94
0000             83   SSDAT          DATA 0x95
0000             84   SSADR          DATA 0x96
0000             85   KBLS           DATA 0x9c
0000             86   KBE            DATA 0x9d
0000             87   KBF            DATA 0x9e
0000             88   KBMOD          DATA 0x9f
0000             89   BMSEL          DATA 0x92
0000             90   FCON           DATA 0xd2
0000             91   EECON          DATA 0xd2
0000             92   ACSRA          DATA 0xa3
0000             93   ACSRB          DATA 0xab
0000             94   AREF           DATA 0xbd
0000             95   DADC           DATA 0xa4
0000             96   DADI           DATA 0xa5
0000             97   DADL           DATA 0xac
0000             98   DADH           DATA 0xad
0000             99   CCON           DATA 0xd8
0000            100   CMOD           DATA 0xd9
0000            101   CL             DATA 0xe9
0000            102   CH             DATA 0xf9
0000            103   CCAPM0         DATA 0xda
0000            104   CCAPM1         DATA 0xdb
0000            105   CCAPM2         DATA 0xdc
0000            106   CCAPM3         DATA 0xdd
0000            107   CCAPM4         DATA 0xde
0000            108   CCAP0H         DATA 0xfa
0000            109   CCAP1H         DATA 0xfb
0000            110   CCAP2H         DATA 0xfc
0000            111   CCAP3H         DATA 0xfd
0000            112   CCAP4H         DATA 0xfe
0000            113   CCAP0L         DATA 0xea
0000            114   CCAP1L         DATA 0xeb
0000            115   CCAP2L         DATA 0xec
0000            116   CCAP3L         DATA 0xed
0000            117   CCAP4L         DATA 0xee
0000            118   ;--------------------------------------------------------
0000            119   ; special function bits
0000            120   ;--------------------------------------------------------
0000            121   P              BIT 0xd0
0000            122   F1             BIT 0xd1
0000            123   OV             BIT 0xd2
0000            124   RS0            BIT 0xd3
0000            125   RS1            BIT 0xd4
0000            126   F0             BIT 0xd5
0000            127   AC             BIT 0xd6
0000            128   CY             BIT 0xd7
0000            129   EX0            BIT 0xa8
0000            130   ET0            BIT 0xa9
0000            131   EX1            BIT 0xaa
0000            132   ET1            BIT 0xab
0000            133   ES             BIT 0xac
0000            134   ET2            BIT 0xad
0000            135   EC             BIT 0xae
0000            136   EA             BIT 0xaf
0000            137   PX0            BIT 0xb8
0000            138   PT0            BIT 0xb9
0000            139   PX1            BIT 0xba
0000            140   PT1            BIT 0xbb
0000            141   PS             BIT 0xbc
0000            142   PT2            BIT 0xbd
0000            143   IP0D           BIT 0xbf
0000            144   PPCL           BIT 0xbe
0000            145   PT2L           BIT 0xbd
0000            146   PLS            BIT 0xbc
0000            147   PT1L           BIT 0xbb
0000            148   PX1L           BIT 0xba
0000            149   PT0L           BIT 0xb9
0000            150   PX0L           BIT 0xb8
0000            151   RXD            BIT 0xb0
0000            152   TXD            BIT 0xb1
0000            153   INT0           BIT 0xb2
0000            154   INT1           BIT 0xb3
0000            155   T0             BIT 0xb4
0000            156   T1             BIT 0xb5
0000            157   WR             BIT 0xb6
0000            158   RD             BIT 0xb7
0000            159   RI             BIT 0x98
0000            160   TI             BIT 0x99
0000            161   RB8            BIT 0x9a
0000            162   TB8            BIT 0x9b
0000            163   REN            BIT 0x9c
0000            164   SM2            BIT 0x9d
0000            165   SM1            BIT 0x9e
0000            166   SM0            BIT 0x9f
0000            167   IT0            BIT 0x88
0000            168   IE0            BIT 0x89
0000            169   IT1            BIT 0x8a
0000            170   IE1            BIT 0x8b
0000            171   TR0            BIT 0x8c
0000            172   TF0            BIT 0x8d
0000            173   TR1            BIT 0x8e
0000            174   TF1            BIT 0x8f
0000            175   CP_RL2         BIT 0xc8
0000            176   C_T2           BIT 0xc9
0000            177   TR2            BIT 0xca
0000            178   EXEN2          BIT 0xcb
0000            179   TCLK           BIT 0xcc
0000            180   RCLK           BIT 0xcd
0000            181   EXF2           BIT 0xce
0000            182   TF2            BIT 0xcf
0000            183   CF             BIT 0xdf
0000            184   CR             BIT 0xde
0000            185   CCF4           BIT 0xdc
0000            186   CCF3           BIT 0xdb
0000            187   CCF2           BIT 0xda
0000            188   CCF1           BIT 0xd9
0000            189   CCF0           BIT 0xd8
0000              2   org 0000H
0000 020386       3      ljmp MainProgram
0003              4   
0003              5   CLK  EQU 22118400
0003              6   BAUD equ 115200
0003              7   BRG_VAL equ (0x100-(CLK/(16*BAUD)))
0003              8   ; These 'equ' must match the hardware wiring
0003              9   LCD_RS equ P1.1
0003             10   LCD_RW equ P1.2 ; Not used in this code
0003             11   LCD_E  equ P1.3
0003             12   LCD_D4 equ P3.2
0003             13   LCD_D5 equ P3.3
0003             14   LCD_D6 equ P3.4
0003             15   LCD_D7 equ P3.5
0003             16   
0003             17   
0003             18   CSEG
0003             19   
0030             20   DSEG at 30H
0030             21   x:   ds 4
0034             22   y:   ds 4
0038             23   bcd: ds 5
003D             24   
0000             25   BSEG
0000             26   mf: dbit 1
0001             27   
                546   $LIST
                 30   	$LIST
0321             32   
0321             33   ; Configure the serial port and baud rate
0321             34   InitSerialPort:
0321             35       ; Since the reset button bounces, we need to wait a bit before
0321             36       ; sending messages, otherwise we risk displaying gibberish!
0321 79DE        37       mov R1, #222
0323 78A6        38       mov R0, #166
0325 D8FE        39       djnz R0, $   ; 3 cycles->3*45.21123ns*166=22.51519us
0327 D9FA        40       djnz R1, $-4 ; 22.51519us*222=4.998ms
0329             41       ; Now we can proceed with the configuration
0329 438780      42            orl     PCON,#0x80
032C 759852      43            mov     SCON,#0x52
032F 759B00      44            mov     BDRCON,#0x00
0332 759AF4      45            mov     BRL,#BRG_VAL
0335 759B1E      46            mov     BDRCON,#0x1E ; BDRCON=BRR|TBCK|RBCK|SPD;
0338 22          47       ret
0339             48   
0339             49   ; Send a character using the serial port
0339             50   putchar:
0339 3099FD      51       jnb TI, putchar
033C C299        52       clr TI
033E F599        53       mov SBUF, a
0340 22          54       ret
0341             55   
0341             56   ; Send a constant-zero-terminated string using the serial port
0341             57   SendString:
0341 E4          58       clr A
0342 93          59       movc A, @A+DPTR
0343 6006        60       jz SendStringDone
0345 120339      61       lcall putchar
0348 A3          62       inc DPTR
0349 80F6        63       sjmp SendString
034B             64   SendStringDone:
034B 22          65       ret
034C             66       
                 67   Send_BCD mac
                 68   	push ar0
                 69   	mov r0, %0
                 70   	mov r0, #0x17
                 71   	lcall ?Send_BCD
                 72   	pop ar0
                 73   endmac
034C             74   
034C             75   ?Send_BCD:
034C C0E0        76            push acc
034E             77            ; Write most significant digit
034E E8          78            mov a, r0
034F C4          79            swap a
0350 540F        80            anl a, #0fh
0352 4430        81            orl a, #30h
0354 120339      82            lcall putchar
0357             83            ; write least significant digit
0357 E8          84            mov a, r0
0358 540F        85            anl a, #0fh
035A 4430        86            orl a, #30h
035C 120339      87            lcall putchar
035F D0E0        88            pop acc
0361 22          89            ret
0362             90    
0362             91   print_bcd:
0362             92   
0362 C0E0        93            push acc
0364 7406        93            mov a, #6
0366 14          93            dec a
0367 120306      93            lcall ?Set_Cursor_1 ; Select column and row
036A D0E0        93            pop acc;
036C 753042      94   mov x,#0x42
036F 120003      95   lcall hex2bcd ; converts binary in x to BCD in BCD
0372 C000        96            push ar0
0374 A838        96            mov r0, bcd
0376 7817        96            mov r0, #0x17
0378 12034C      96            lcall ?Send_BCD
037B D000        96            pop ar0
037D 900383      97   mov DPTR,#Space
0380 120341      98   lcall SendString
0383             99   
0383            100   
0383            101   Space:
0383 0D0A00     102   DB '\r','\n',0
0386            103    
0386            104   MainProgram:
0386 75817F     105       mov SP, #7FH ; Set the stack pointer to the begining of idata
0389            106     
0389 120321     107       lcall InitSerialPort
038C 120362     108       lcall print_bcd
038F            109       
038F            110       
038F 80FE       111       sjmp $ ; This is equivalent to 'forever: sjmp forever'
0391            112       
0391            113   END
